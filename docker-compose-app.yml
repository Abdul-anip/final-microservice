services:
  # -------------------------------------------------------------------------
  # Infrastructure Services
  # -------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - elk
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------------------------------------------------------
  # Microservices
  # -------------------------------------------------------------------------
  eureka-server:
    image: eureka-server:latest
    build:
      context: ./eureka_server
      dockerfile: Dockerfile
    container_name: eureka-server
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "8761:8761"
    networks:
      - elk
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 40s

  api-gateway:
    image: api-gateway:latest
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "9000:9000"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=api-gateway
    networks:
      - elk
    depends_on:
      eureka-server:
        condition: service_healthy

  anggota-service:
    image: anggota-service:latest
    build:
      context: ./anggota
      dockerfile: Dockerfile
    container_name: anggota-service
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "8081:8081"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - LOGSTASH_HOST=logstash
    networks:
      - elk
    depends_on:
      eureka-server:
        condition: service_healthy

  buku-service:
    image: buku-service:latest
    build:
      context: ./buku
      dockerfile: Dockerfile
    container_name: buku-service
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "8082:8082"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - LOGSTASH_HOST=logstash
    networks:
      - elk
    depends_on:
      eureka-server:
        condition: service_healthy

  peminjaman-service:
    image: peminjaman-service:latest
    build:
      context: ./peminjaman
      dockerfile: Dockerfile
    container_name: peminjaman-service
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "8083:8083"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - SPRING_RABBITMQ_HOST=rabbitmq
      - LOGSTASH_HOST=logstash
    networks:
      - elk
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  pengembalian-service:
    image: pengembalian-service:latest
    build:
      context: ./pengembalian
      dockerfile: Dockerfile
    container_name: pengembalian-service
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "8084:8084"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - SPRING_RABBITMQ_HOST=rabbitmq
      - LOGSTASH_HOST=logstash
    networks:
      - elk
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  email-service:
    image: email-service:latest
    build:
      context: ./email
      dockerfile: Dockerfile
    container_name: email-service
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "8085:8085"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - SPRING_RABBITMQ_HOST=rabbitmq
      - LOGSTASH_HOST=logstash
    networks:
      - elk
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

networks:
  elk:
    name: latihan_perpustakaan_elk
    external: true
